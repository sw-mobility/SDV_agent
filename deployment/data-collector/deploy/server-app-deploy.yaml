# FastAPI Server App Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: data-collector-deployment
  labels:
    app: data-collector
spec:
  replicas: 2 # ë°ì´í„° ìˆ˜ì§‘ì˜ ì•ˆì •ì„±ì„ ìœ„í•´ ë³µì œë³¸ 2ê°œ ì‚¬ìš©
  selector:
    matchLabels:
      app: data-collector
  template:
    metadata:
      labels:
        app: data-collector
    spec:
      containers:
      - name: data-collector-container
        # ğŸ’¡ ì‚¬ìš©ìê°€ ë¹Œë“œí•˜ì—¬ í‘¸ì‹œí•œ ì´ë¯¸ì§€ ê²½ë¡œ ì‚¬ìš©
        image: registry.suredatalab.kr/etri/sdv/data-collector:v1 
        ports:
        - containerPort: 8000 # Dockerfileì—ì„œ ì„¤ì •í•œ í¬íŠ¸ (8000)
        
        env:
        # 1. DB ì—°ê²° ì •ë³´
        - name: DB_HOST
          value: "postgresql-service" # PostgreSQL Service ì´ë¦„
        - name: DB_DATABASE
          value: "sdv_ev"
        - name: DB_USER
          value: "sdv"
        - name: DB_PASSWORD
          value: "password" # âš ï¸ ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸
        - name: DB_PORT
          value: "5432"

        # 2. S3 (RGW) ì—°ê²° ì •ë³´
        - name: S3_ENDPOINT_URL
          value: "http://s3.suredatalab.kr" # ğŸ’¡ S3 Endpoint URL
        - name: S3_BUCKET_NAME
          value: "sdv-ml-data" # âš ï¸ ì‚¬ìš©í•  ë²„í‚· ì´ë¦„ìœ¼ë¡œ ë³€ê²½
        
        # S3 Access KeyëŠ” Secretì—ì„œ ê°€ì ¸ì˜´
        - name: S3_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              name: sdv-user-rgw-secret # ğŸ’¡ ì •ì˜í•œ Secret ì´ë¦„
              key: AWS_ACCESS_KEY_ID # Secret ë‚´ì˜ í‚¤ ì´ë¦„
        
        # S3 Secret KeyëŠ” Secretì—ì„œ ê°€ì ¸ì˜´
        - name: S3_SECRET_KEY
          valueFrom:
            secretKeyRef:
              name: sdv-user-rgw-secret # ğŸ’¡ ì •ì˜í•œ Secret ì´ë¦„
              key: AWS_SECRET_ACCESS_KEY # Secret ë‚´ì˜ í‚¤ ì´ë¦„
---
# FastAPI Server App Service
apiVersion: v1
kind: Service
metadata:
  name: data-collector-service
spec:
  selector:
    app: data-collector
  # ğŸ’¡ ì—£ì§€ ë””ë°”ì´ìŠ¤ê°€ ì™¸ë¶€ì—ì„œ ì ‘ì†í•´ì•¼ í•˜ë¯€ë¡œ LoadBalancer ì‚¬ìš©
  type: NodePort
  ports:
    - protocol: TCP
      port: 80 # ì™¸ë¶€ ë…¸ì¶œ í¬íŠ¸ (ì˜ˆ: http://[LoadBalancer IP]:80)
      targetPort: 8000 # ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í¬íŠ¸
      nodePort: 30888 # í•„ìš”ì— ë”°ë¼ ë°”ê¾¼ë‹¤.
